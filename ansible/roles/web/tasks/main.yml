---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_facts.os_family == "Debian"

- name: Install packages
  ansible.builtin.apt:
    name:
      - nginx
      - php-fpm
      - logrotate
    state: present
  when: ansible_facts.os_family == "Debian"

# Визначаємо версію php-fpm через наявний шлях /etc/php/<ver>/fpm/pool.d/www.conf
- name: Find php-fpm pool config
  ansible.builtin.find:
    paths: /etc/php
    patterns: "www.conf"
    file_type: file
    recurse: true
  register: web_php_pool_find
  when: ansible_facts.os_family == "Debian"

- name: Fail if php-fpm pool config not found
  ansible.builtin.fail:
    msg: "Cannot find PHP-FPM pool config under /etc/php/*/fpm/pool.d/www.conf"
  when:
    - ansible_facts.os_family == "Debian"
    - web_php_pool_find.matched | int == 0

- name: Set php-fpm service and socket
  ansible.builtin.set_fact:
    web_php_fpm_version: "{{ (web_php_pool_find.files[0].path | regex_search('^/etc/php/([0-9.]+)/fpm/', '\\1'))[0] }}"
    web_php_fpm_service: "php{{ (web_php_pool_find.files[0].path | regex_search('^/etc/php/([0-9.]+)/fpm/', '\\1'))[0] }}-fpm"
    web_php_fpm_socket: "/run/php/php{{ (web_php_pool_find.files[0].path | regex_search('^/etc/php/([0-9.]+)/fpm/', '\\1'))[0] }}-fpm.sock"
  when: ansible_facts.os_family == "Debian"

- name: Ensure web root exists
  ansible.builtin.file:
    path: "{{ web_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

- name: Deploy index.php
  ansible.builtin.template:
    src: index.php.j2
    dest: "{{ web_root }}/index.php"
    owner: www-data
    group: www-data
    mode: "0644"

- name: Deploy nginx vhost config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/web.conf
    mode: "0644"
  notify: restart nginx

- name: Disable default site if exists
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Validate nginx config
  ansible.builtin.command: nginx -t
  changed_when: false

- name: Configure logrotate for nginx logs
  ansible.builtin.template:
    src: logrotate-nginx.j2
    dest: /etc/logrotate.d/nginx-web
    mode: "0644"

- name: Ensure nginx running and enabled
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true

- name: Ensure php-fpm running and enabled
  ansible.builtin.service:
    name: "{{ web_php_fpm_service }}"
    state: started
    enabled: true
